<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wizinno.apollo.app.domain.AppInstallInfoMapper" >
  <resultMap id="BaseResultMap" type="com.wizinno.apollo.app.domain.model.AppInstallInfo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Sep 15 11:47:53 CST 2017.
    -->
    <id column="check_time" property="checkTime" jdbcType="TIMESTAMP" />
    <id column="user_id" property="userId" jdbcType="VARCHAR" />
    <id column="dev_id" property="devId" jdbcType="VARCHAR" />
    <id column="app_package" property="appPackage" jdbcType="VARCHAR" />
    <result column="app_name" property="appName" jdbcType="VARCHAR" />
    <result column="app_ver" property="appVer" jdbcType="VARCHAR" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Sep 15 11:47:53 CST 2017.
    -->
    delete from app_install_info
    where check_time = #{checkTime,jdbcType=TIMESTAMP}
      and user_id = #{userId,jdbcType=VARCHAR}
      and dev_id = #{devId,jdbcType=VARCHAR}
      and app_package = #{appPackage,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.wizinno.apollo.app.domain.model.AppInstallInfo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Sep 15 11:47:53 CST 2017.
    -->
    insert into app_install_info (check_time, user_id, dev_id, 
      app_package, app_name, app_ver
      )
    values (#{checkTime,jdbcType=TIMESTAMP}, #{userId,jdbcType=VARCHAR}, #{devId,jdbcType=VARCHAR}, 
      #{appPackage,jdbcType=VARCHAR}, #{appName,jdbcType=VARCHAR}, #{appVer,jdbcType=VARCHAR}
      )
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.wizinno.apollo.app.domain.model.AppInstallInfo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Sep 15 11:47:53 CST 2017.
    -->
    update app_install_info
    set app_name = #{appName,jdbcType=VARCHAR},
      app_ver = #{appVer,jdbcType=VARCHAR}
    where check_time = #{checkTime,jdbcType=TIMESTAMP}
      and user_id = #{userId,jdbcType=VARCHAR}
      and dev_id = #{devId,jdbcType=VARCHAR}
      and app_package = #{appPackage,jdbcType=VARCHAR}
  </update>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Sep 15 11:47:53 CST 2017.
    -->
    select check_time, user_id, dev_id, app_package, app_name, app_ver
    from app_install_info
    where check_time = #{checkTime,jdbcType=TIMESTAMP}
      and user_id = #{userId,jdbcType=VARCHAR}
      and dev_id = #{devId,jdbcType=VARCHAR}
      and app_package = #{appPackage,jdbcType=VARCHAR}
  </select>
  <select id="selectAll" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Sep 15 11:47:53 CST 2017.
    -->
    select check_time, user_id, dev_id, app_package, app_name, app_ver
    from app_install_info
  </select>

 <select id="getAppInstalls" resultType="com.wizinno.apollo.app.dto.AppInstallAndDeviceDto" parameterType="com.wizinno.apollo.common.condition.AppInstallsCondition">
   select aii.check_time as checkTime, aii.user_id as userId, aii.dev_id as devId,any_value(aii.app_package) as appPackage,
   any_value(aii.app_name) as appName,any_value(aii.app_ver) as appVer,u.u_name as uName,u.mobile_num as mobileNum,COUNT(1) as  appInstallTotal,any_value(d.dev_imei) as devImei
   from app_install_info aii
   LEFT JOIN `user` u ON u.user_id=aii.user_id
   LEFT JOIN device d on d.dev_id=aii.dev_id
    <where>
      <if test="uName != null">AND u.u_name = #{uName,jdbcType=VARCHAR}</if>
      <if test="mobileNum != null">AND u.mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
    </where>
   GROUP BY aii.check_time,aii.user_id,aii.dev_id
   order BY checkTime desc
    limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
  </select>


 <select id="getAppInstallsTotal" parameterType="com.wizinno.apollo.common.condition.AppInstallsCondition" resultType="java.lang.Long">
   SELECT count(1) FROM (select aii.check_time as checkTime, aii.user_id as userId, aii.dev_id as devId,any_value(aii.app_package) as appPackage,
   any_value(aii.app_name) as appName,any_value(aii.app_ver) as appVer,u.u_name as uName,u.mobile_num as mobileNum,COUNT(1) as  appInstallTotal,any_value(d.dev_imei) as devImei
   from app_install_info aii
   LEFT JOIN `user` u ON u.user_id=aii.user_id
   LEFT JOIN device d on d.dev_id=aii.dev_id
   <where>
     <if test="uName != null">AND u.u_name = #{uName,jdbcType=VARCHAR}</if>
     <if test="mobileNum != null">AND u.mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
   </where>
   GROUP BY aii.check_time,aii.user_id,aii.dev_id)a

  </select>


  <select id="getAppInstallsByPK" parameterType="map" resultType="java.lang.Integer">
    select count(1)
    from app_install_info
    WHERE check_time=#{checkTime,jdbcType=TIMESTAMP} AND user_id=#{userId,jdbcType=VARCHAR} AND dev_id=#{devId,jdbcType=VARCHAR}

  </select>
</mapper>