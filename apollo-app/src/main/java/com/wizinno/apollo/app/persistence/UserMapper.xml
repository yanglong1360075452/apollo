<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wizinno.apollo.app.domain.UserMapper" >
  <resultMap id="BaseResultMap" type="com.wizinno.apollo.app.domain.model.User" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 02 15:26:10 CST 2017.
    -->
    <id column="user_id" property="userId" jdbcType="VARCHAR" />
    <result column="mobile_num" property="mobileNum" jdbcType="VARCHAR" />
    <result column="operator" property="operator" jdbcType="VARCHAR" />
    <result column="net_system" property="netSystem" jdbcType="VARCHAR" />
    <result column="password" property="password" jdbcType="VARCHAR" />
    <result column="u_name" property="uName" jdbcType="VARCHAR" />
    <result column="u_sex" property="uSex" jdbcType="INTEGER" />
    <result column="u_address" property="uAddress" jdbcType="VARCHAR" />
    <result column="u_birthdate" property="uBirthdate" jdbcType="DATE" />
    <result column="u_reg_date" property="uRegDate" jdbcType="TIMESTAMP" />
    <result column="state" property="state" jdbcType="INTEGER" />
    <result column="test_time" property="testTime" jdbcType="TIMESTAMP" />
    <result column="app_name" property="appName" jdbcType="VARCHAR" />
    <result column="is_front_app" property="isFrontApp" jdbcType="INTEGER" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 02 15:26:10 CST 2017.
    -->
    delete from user
    where user_id = #{userId,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.wizinno.apollo.app.domain.model.User" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 02 15:26:10 CST 2017.
    -->
    insert into user (user_id, mobile_num, operator, 
      net_system, password, u_name, 
      u_sex, u_address, u_birthdate, 
      u_reg_date, state)
    values (#{userId,jdbcType=VARCHAR}, #{mobileNum,jdbcType=VARCHAR}, #{operator,jdbcType=VARCHAR}, 
      #{netSystem,jdbcType=VARCHAR}, #{password,jdbcType=VARCHAR}, #{uName,jdbcType=VARCHAR}, 
      #{uSex,jdbcType=INTEGER}, #{uAddress,jdbcType=VARCHAR}, #{uBirthdate,jdbcType=DATE}, 
      #{uRegDate,jdbcType=TIMESTAMP}, #{state,jdbcType=INTEGER})
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.wizinno.apollo.app.domain.model.User" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 02 15:26:10 CST 2017.
    -->
    update user
    set mobile_num = #{mobileNum,jdbcType=VARCHAR},
      operator = #{operator,jdbcType=VARCHAR},
      net_system = #{netSystem,jdbcType=VARCHAR},
      password = #{password,jdbcType=VARCHAR},
      u_name = #{uName,jdbcType=VARCHAR},
      u_sex = #{uSex,jdbcType=INTEGER},
      u_address = #{uAddress,jdbcType=VARCHAR},
      u_birthdate = #{uBirthdate,jdbcType=DATE},
      u_reg_date = #{uRegDate,jdbcType=TIMESTAMP},
      state = #{state,jdbcType=INTEGER}
    where user_id = #{userId,jdbcType=VARCHAR}
  </update>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 02 15:26:10 CST 2017.
    -->
    select user_id, mobile_num, operator, net_system, password, u_name, u_sex, u_address, 
    u_birthdate, u_reg_date, state
    from user
    where user_id = #{userId,jdbcType=VARCHAR}
  </select>
  <select id="selectAll" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 02 15:26:10 CST 2017.
    -->
    select user_id, mobile_num, operator, net_system, password, u_name, u_sex, u_address, 
    u_birthdate, u_reg_date, state
    from user
  </select>

  <select id="getUserByMobileNum" resultMap="BaseResultMap" parameterType="java.lang.String">
    select user_id, mobile_num, operator, net_system, password, u_name, u_sex, u_address,
    u_birthdate, u_reg_date, state
    from user WHERE mobile_num=#{mobileNum,jdbcType=VARCHAR}
  </select>

  <select id="getUserByMobileNumOrUname" resultMap="BaseResultMap" parameterType="java.lang.String">
    select user_id, mobile_num, operator, net_system, password, u_name, u_sex, u_address,
    u_birthdate, u_reg_date, state
    from user WHERE mobile_num=#{uName,jdbcType=VARCHAR} OR u_name=#{uName,jdbcType=VARCHAR}
  </select>

  <select id="getUserByUname" resultMap="BaseResultMap" parameterType="java.lang.String">
      select user_id, mobile_num, operator, net_system, password, u_name, u_sex, u_address,
    u_birthdate, u_reg_date, state
    from user WHERE u_name=#{uName,jdbcType=VARCHAR}

  </select>

  <select id="getUsers" resultMap="BaseResultMap" parameterType="com.wizinno.apollo.common.condition.UserCondition">
    select user_id, mobile_num, operator, net_system, u_name, u_sex, u_address,
    u_birthdate, u_reg_date, state
    from user
    <where>
      <if test="uName != null">AND u_name = #{uName,jdbcType=VARCHAR}</if>
      <if test="mobileNum != null">AND mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
      <if test="operator != null">AND operator = #{operator,jdbcType=VARCHAR}</if>
    </where>
    order BY u_reg_date desc
    limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
  </select>

  <select id="getUsersTotal" resultType="java.lang.Long" parameterType="com.wizinno.apollo.common.condition.UserCondition">
    select count(1)
    from user
    <where>
      <if test="uName != null">AND u_name = #{uName,jdbcType=VARCHAR}</if>
      <if test="mobileNum != null">AND mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
      <if test="operator != null">AND operator = #{operator,jdbcType=VARCHAR}</if>
    </where>

  </select>


  <select id="getExceptionsUsers" parameterType="com.wizinno.apollo.common.condition.UserCondition" resultMap="BaseResultMap">
    select u.user_id, u.mobile_num, u.operator, u.net_system,
    u.password, u.u_name, u.u_sex, u.u_address,
    u.u_birthdate, u.u_reg_date, u.state,a.test_time
    from user u
    INNER JOIN (
    SELECT MAX(test_time) as test_time, mobile_num FROM net_test_log
    GROUP BY mobile_num) a ON a.mobile_num=u.mobile_num
    <where>
      <if test="uName != null">AND u.u_name = #{uName,jdbcType=VARCHAR}</if>
      <if test="mobileNum != null">AND u.mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
      <if test="operator != null">AND operator = #{operator,jdbcType=VARCHAR}</if>
      and round((UNIX_TIMESTAMP(NOW())-UNIX_TIMESTAMP(a.test_time))/60) > #{exceptionsTime,jdbcType=VARCHAR}
    </where>
    order BY test_time desc
    limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}

  </select>


<!--  <select id="getExceptionsUsers" parameterType="com.wizinno.apollo.common.condition.UserCondition" resultMap="BaseResultMap">
    SELECT ANY_value(user_id) as user_id, mobile_num, ANY_value(operator) as operator, any_value(net_system) as net_system ,
    ANY_value(u_name) as u_name, any_value(u_sex) as u_sex, any_value(u_address) as u_address,
    any_value(u_birthdate) as u_birthdate, any_value(u_reg_date) as u_reg_date,
    any_value(state) as state ,any_value(test_time) as test_time,
    any_value(is_front_app) as  is_front_app FROM
    (select u.user_id, u.mobile_num, u.operator, u.net_system,
    u.password, u.u_name, u.u_sex, u.u_address,
    u.u_birthdate, u.u_reg_date, u.state,a.test_time,a.is_front_app
    from user u
    INNER JOIN (
    SELECT MAX(test_time) as test_time, mobile_num,any_value(is_front_app) as is_front_app FROM net_test_log
    GROUP BY mobile_num) a ON a.mobile_num=u.mobile_num
    WHERE
    round((UNIX_TIMESTAMP(NOW())-UNIX_TIMESTAMP(a.test_time))/60) > 90

    UNION ALL

    select u.user_id, u.mobile_num, u.operator, u.net_system,
    u.password, u.u_name, u.u_sex, u.u_address,
    u.u_birthdate, u.u_reg_date, u.state,any_value(ntl.test_time) as test_time,ntl.is_front_app
    from user u
    LEFT JOIN net_test_log ntl ON ntl.mobile_num= u.mobile_num
    WHERE ntl.is_front_app=0
    GROUP BY u.mobile_num ) a

    <where>
      <if test="uName != null">AND a.u_name = #{uName,jdbcType=VARCHAR}</if>
      <if test="mobileNum != null">AND a.mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
      <if test="operator != null">AND operator = #{operator,jdbcType=VARCHAR}</if>
  </where>
    GROUP BY a.mobile_num
    order BY any_value(test_time) desc
    limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}

  </select>-->

<!--
  <select id="getExceptionsUsersTotal" parameterType="com.wizinno.apollo.common.condition.UserCondition" resultType="java.lang.Long">
   SELECT count(1) FROM (SELECT ANY_value(user_id), mobile_num, ANY_value(operator), any_value(net_system),
    ANY_value(u_name), any_value(u_sex), any_value(u_address),
    any_value(u_birthdate), any_value(u_reg_date),any_value(state) ,any_value(test_time),
    any_value(is_front_app)  FROM
    (select u.user_id, u.mobile_num, u.operator, u.net_system,
    u.password, u.u_name, u.u_sex, u.u_address,
    u.u_birthdate, u.u_reg_date, u.state,a.test_time,a.is_front_app
    from user u
    INNER JOIN (
    SELECT MAX(test_time) as test_time, mobile_num,any_value(is_front_app) as is_front_app FROM net_test_log
    GROUP BY mobile_num) a ON a.mobile_num=u.mobile_num
    WHERE
    round((UNIX_TIMESTAMP(NOW())-UNIX_TIMESTAMP(a.test_time))/60) > 90

    UNION ALL

    select u.user_id, u.mobile_num, u.operator, u.net_system,
    u.password, u.u_name, u.u_sex, u.u_address,
    u.u_birthdate, u.u_reg_date, u.state,any_value(ntl.test_time) as test_time,ntl.is_front_app
    from user u
    LEFT JOIN net_test_log ntl ON ntl.mobile_num= u.mobile_num
    WHERE ntl.is_front_app=0
    GROUP BY u.mobile_num ) a

    <where>
      <if test="uName != null">AND a.u_name = #{uName,jdbcType=VARCHAR}</if>
      <if test="mobileNum != null">AND a.mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
      <if test="operator != null">AND operator = #{operator,jdbcType=VARCHAR}</if>
    </where>
    GROUP BY a.mobile_num ) b

  </select>-->


    <select id="getExceptionsUsersTotal" parameterType="com.wizinno.apollo.common.condition.UserCondition" resultType="java.lang.Long">
      select count(1)
      from user u
      INNER JOIN (
      SELECT MAX(test_time) as test_time, mobile_num FROM net_test_log
      GROUP BY mobile_num) a ON a.mobile_num=u.mobile_num
      <where>
        <if test="uName != null">AND u.u_name = #{uName,jdbcType=VARCHAR}</if>
        <if test="mobileNum != null">AND u.mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
        <if test="operator != null">AND operator = #{operator,jdbcType=VARCHAR}</if>
        and round((UNIX_TIMESTAMP(NOW())-UNIX_TIMESTAMP(a.test_time))/60) > #{exceptionsTime,jdbcType=VARCHAR}
      </where>

    </select>



  <select id="getNopermissionUsers" parameterType="com.wizinno.apollo.common.condition.UserCondition" resultMap="BaseResultMap">
    select u.user_id, u.mobile_num, u.operator, u.net_system,
    u.password, u.u_name, u.u_sex, u.u_address,
    u.u_birthdate, u.u_reg_date, u.state,a.test_time,a.is_front_app
    from user u
    inner join (select a.test_time,a.mobile_num,a.is_front_app,a.app_name from
    (select  test_time,  mobile_num, is_front_app,app_name FROM net_test_log) a
    INNER  join (
    SELECT MAX(test_time) as test_time, any_value(mobile_num) as  mobile_num FROM net_test_log
    group by mobile_num) b ON a.mobile_num=b.mobile_num AND a.test_time=b.test_time

    WHERE is_front_app=0) a on a.mobile_num=u.mobile_num
    <where>
      <if test="uName != null">AND u.u_name = #{uName,jdbcType=VARCHAR}</if>
      <if test="mobileNum != null">AND u.mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
      <if test="operator != null">AND operator = #{operator,jdbcType=VARCHAR}</if>
    </where>
    order BY test_time desc
    limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}

  </select>



  <select id="getNopermissionUsersTotal" parameterType="com.wizinno.apollo.common.condition.UserCondition" resultMap="BaseResultMap">
    SELECT count(1) FROM (select u.user_id, u.mobile_num, u.operator, u.net_system,
    u.password, u.u_name, u.u_sex, u.u_address,
    u.u_birthdate, u.u_reg_date, u.state,a.test_time,a.is_front_app
    from user u
    inner join (select a.test_time,a.mobile_num,a.is_front_app,a.app_name from
    (select test_time, mobile_num, is_front_app,app_name FROM net_test_log) a
    INNER join (
    SELECT MAX(test_time) as test_time, any_value(mobile_num) as mobile_num FROM net_test_log
    group by mobile_num) b ON a.mobile_num=b.mobile_num AND a.test_time=b.test_time

    WHERE is_front_app=0) a on a.mobile_num=u.mobile_num
    <where>
      <if test="uName != null">AND u.u_name = #{uName,jdbcType=VARCHAR}</if>
      <if test="mobileNum != null">AND u.mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
      <if test="operator != null">AND operator = #{operator,jdbcType=VARCHAR}</if>
    </where>) c


  </select>

  <select id="getDisabledUsers" parameterType="com.wizinno.apollo.common.condition.UserCondition" resultMap="BaseResultMap">

    select u.user_id, u.mobile_num, u.operator, u.net_system,
    u.password, u.u_name, u.u_sex, u.u_address,
    u.u_birthdate, u.u_reg_date, u.state,a.test_time
    from user u
    INNER JOIN (
    SELECT MAX(test_time) as test_time, mobile_num FROM net_test_log
    WHERE screen_shap  is not null
    GROUP BY mobile_num) a ON a.mobile_num=u.mobile_num
    <where>
      <if test="uName != null">AND u.u_name = #{uName,jdbcType=VARCHAR}</if>
      <if test="mobileNum != null">AND u.mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
      <if test="operator != null">AND operator = #{operator,jdbcType=VARCHAR}</if>
      and HOUR(timediff(NOW(),a.test_time)) > 24
    </where>
    order BY test_time desc
    limit #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
  </select>

  <select id="getDisabledUsersTotal" parameterType="com.wizinno.apollo.common.condition.UserCondition" resultType="java.lang.Long">
    select count(1)
    from user u
    INNER JOIN (
    SELECT MAX(test_time) as test_time, mobile_num FROM net_test_log
    WHERE screen_shap  is not null
    GROUP BY mobile_num) a ON a.mobile_num=u.mobile_num
    <where>
      <if test="uName != null">AND u.u_name = #{uName,jdbcType=VARCHAR}</if>
      <if test="mobileNum != null">AND u.mobile_num = #{mobileNum,jdbcType=VARCHAR}</if>
      <if test="operator != null">AND operator = #{operator,jdbcType=VARCHAR}</if>
      and HOUR(timediff(NOW(),a.test_time)) > 24
    </where>
  </select>


  <select id="getExceptionsUsersAll" resultMap="BaseResultMap">
    select u.user_id, u.mobile_num, u.operator, u.net_system,
    u.password, u.u_name, u.u_sex, u.u_address,
    u.u_birthdate, u.u_reg_date, u.state,a.test_time
    from user u
    INNER JOIN (
    SELECT MAX(test_time) as test_time, mobile_num FROM net_test_log
    GROUP BY mobile_num) a ON a.mobile_num=u.mobile_num
    WHERE
       round((UNIX_TIMESTAMP(NOW())-UNIX_TIMESTAMP(a.test_time))/60) > 90


  </select>
</mapper>